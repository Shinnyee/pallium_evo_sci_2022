---
title: "Div-seq Analysis"
output: html_notebook
---



# General Setup
Setup chunk

```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8)
#knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_knit$set(root.dir = "/links/groups/treutlein/USERS/tomasgomes/projects/pallium_evo")
knitr::opts_knit$get("root.dir")
```

Setup reticulate

```{r}
library(reticulate)
knitr::knit_engines$set(python = reticulate::eng_python)
py_available(initialize = FALSE)
use_python(Sys.which("python"))
py_config()
```

Load libraries

```{r}
library(Seurat)
library(patchwork)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(parallel)
library(doParallel)
library(foreach)
library(ggdendro)
library(presto)
library(scatterpie)
```

Set colours for cell types and regions

```{r}
meta = read.csv("data/annotations/axolotl_all_umeta.csv", 
                header = T, row.names = 1)
cols_cc = c(
#epen
"#12400c", "#2d6624","#1d4f15", "#174711", "#2d6624", "#3d7f33", "#3b7b30", "#468b3b", "#4f9843","#5dae50", "#66bb58", "#72cd64", "#306a26", "#78d669", "#81e472",
#gaba
"#700209", "#75090e","#7a0f13", "#801517", "#851a1b", "#8a1f1f", "#902423", "#952927", "#9a2d2c","#a03230", "#a53634", "#aa3a39", "#b03f3d","#b54342", "#ba4846", "#c04c4b", "#c5504f", "#ca5554", "#d05959", "#d55e5e","#73050c", "#780c11","#8d2221", "#982b2a","#a23432", "#a83837", "#b2413f", "#b84544", "#bd4a49", "#c85352", #"#cd5756",
#glut
"#054674", "#134d7b","#1d5481", "#265a88", "#2e618e", "#73a4cb", "#366995", "#3e709c", "#4677a2","#4d7ea9", "#5586b0", "#5c8db7", "#6495bd","#6b9cc4", "#7bacd2", "#8ebfe4", "#96c7eb", "#9ecff2", "#18507e", "#18507e","#2a5e8b", "#497ba6","#5889b3", "#6fa0c8","#7fafd6", "#6091ba", "#5182ac", "#3a6c98", "#a6d7f9",
#npc
"#ffb120", "#feb72a","#fdbc34", "#fcc13d", "#fbc745", "#facc4e", "#f9d156", "#f8d65f", "#f8da68","#f7df70", "#f7e479", "#f7e882", "#f7ed8a", "#f7f193", "#eca319"
)
ccnames = unique(sort(meta$cellclusters))
names(cols_cc) = c(ccnames[grepl("epen", ccnames)], ccnames[grepl("GABA", ccnames)],ccnames[grepl("glut", ccnames)],ccnames[grepl("npc", ccnames)])

cols_cc = c(cols_cc, "microglia_8" = "#E6530D", 
            "oligodendrocyte_15" = "#E43D88", "oligodendrocyte_10" = "#F662A5",
            "endothelial_11" = "#712166", "endothelial_12" = "#B0279D", 
            "endothelial_14" = "#BE5AB0")

reg_cols = c("other/unknown_pred" = "#C7CCC7", 
             "medial" = "#52168D", "medial_pred" = "#661CB0", 
             "dorsal" = "#C56007", "dorsal_pred" = "#ED7307", 
             "lateral" = "#118392", "lateral_pred" = "#16A3B6")
reg_cols_simp = c("medial" = "#52168D", "dorsal" = "#C56007", "lateral" = "#118392")
```



# Prepare data
Load Div-seq

```{r}
div_dat = readRDS("data/expression/axolotl_reclust/Edu_1_2_4_6_8_12_fil_highvarfeat.RDS")
```

Save necessary data

```{r}
outname = "data/processed/axolotl_parts/div_regions_data.mtx"
outname2 = "data/processed/axolotl_parts/div_regions_counts.mtx"
if(!file.exists(outname)){
  metadata_ax = div_dat@meta.data[,c("sample", "batch", "highlevel_clusters")]
  write.csv(metadata_ax, file = "data/processed/axolotl_parts/div_regions_meta.csv", 
            col.names = T, row.names = T, quote = F)
  write.csv(div_dat@assays$RNA@meta.features, 
            file = "data/processed/axolotl_parts/div_regions_genes.csv", 
            col.names = T, row.names = T, quote = F)
  
  Matrix::writeMM(Matrix::t(div_dat@assays$RNA@data), outname)
  Matrix::writeMM(Matrix::t(div_dat@assays$RNA@counts), outname2)
}
```



# Region predictions
Load results from models

```{r}
all_pred_f = list.files("results/Div-seq/", pattern = "preds_")
all_pred_f = all_pred_f[grepl("lr", all_pred_f) & !grepl("CT", all_pred_f)]
# test set results
test_res = lapply(all_pred_f[grepl("ax.csv", all_pred_f)], 
                  function(x) read.csv(paste0("results/Div-seq/", x), header = T))
names(test_res) = unlist(lapply(strsplit(all_pred_f[grepl("ax.csv", all_pred_f)], ".", fixed = T),
                                function(x) x[1]))

# Div-seq results
div_res = lapply(all_pred_f[grepl("div", all_pred_f)], 
                 function(x) read.csv(paste0("results/Div-seq/", x), header = T))
names(div_res) = unlist(lapply(strsplit(all_pred_f[grepl("div", all_pred_f)], ".", fixed = T),
                               function(x) x[1]))
```

Confusion matrices

```{r}
test_labs_l = list()
for(g in c("all", "dif", "neu")){
  n1 = names(test_res)[grepl(g, names(test_res)) & grepl("lr", names(test_res))]
  test_labs_l[[g]] = test_res[[n1]]
  print(g)
  print(table(test_labs_l[[g]]$y_test, test_labs_l[[g]]$pred_lr))
}

div_labs_l = list()
for(g in c("all", "dif", "neu")){
  n1 = names(div_res)[grepl(g, names(div_res)) & grepl("lr", names(div_res))]
  div_labs_l[[g]] = div_res[[n1]]
} 
```

Compare all with neu/dif (test sets are different so overlap is not complete)

```{r}
test_all_neu = merge(test_labs_l$all, test_labs_l$neu, by = 1)
table(test_all_neu$pred_lr.x, test_all_neu$pred_lr.y)

test_all_ep = merge(test_labs_l$all, test_labs_l$dif, by = 1)
table(test_all_ep$pred_lr.x, test_all_ep$pred_lr.y)


div_all_neu = merge(div_labs_l$all, div_labs_l$neu, by = 1)
table(div_all_neu$pred_lr.x, div_all_neu$pred_lr.y)

div_all_ep = merge(div_labs_l$all, div_labs_l$dif, by = 1)
table(div_all_ep$pred_lr.x, div_all_ep$pred_lr.y)
```

Plot UMAP with regions

```{r}
div_dat$pred_regs = div_res$preds_lr_div_all$pred_lr
DimPlot(div_dat, reduction = "umap_harmony", group.by = "highlevel_clusters", label = T)
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_regs")
FeaturePlot(div_dat, reduction = "umap_harmony", features = c("SFRP1", "WNT8B", "UNC5C"))

reg_cols_simp = c("medial" = "#52168D", "dorsal" = "#C56007", "lateral" = "#118392")

plt = DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_regs", shuffle = T)+
  scale_colour_manual(values = reg_cols_simp)+
  theme(aspect.ratio = 1,
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

pdf("results/Div-seq/Divseq_results/divseq_umap_regions.pdf", height = 2.7, width = 2.7)
print(plt)
dev.off()
```

Plot changes in proportion

```{r}
tab_ct_reg = table(paste0(div_dat$sample, "..", div_dat$high_level_anno), div_dat$pred_regs)
tab_ct_reg = data.frame(tab_ct_reg)

tab_ct_reg$time = unlist(lapply(strsplit(as.character(tab_ct_reg$Var1), "_"), 
                                function(x) paste0(x[1], "_wpi")))
tab_ct_reg$ct = unlist(lapply(strsplit(as.character(tab_ct_reg$Var1), "..", fixed = T), 
                                function(x) x[2]))

for(r in unique(tab_ct_reg$time)){
  cc = tab_ct_reg$time==r
  tab_ct_reg$Freq[cc] = tab_ct_reg$Freq[cc]/sum(tab_ct_reg$Freq[cc])
}

for(r in unique(tab_ct_reg$ct)){
  cc = tab_ct_reg$ct==r
  tab_ct_reg$Freq[cc] = scales::rescale(tab_ct_reg$Freq[cc], c(0,1))
}

tab_ct_reg$ct = factor(tab_ct_reg$ct, levels = c("microglia", "endo", 
                                                 "ependymal_a", "ependymal_q", "NPC",
                                                 "neuronal"))
tab_ct_reg$time = factor(tab_ct_reg$time, 
                         levels = rev(c("1_wpi", "2_wpi", "4_wpi", "6_wpi", "8_wpi", "12_wpi")))
tab_ct_reg$Var2 = factor(tab_ct_reg$Var2, 
                         levels = c("medial","dorsal","lateral"))

plt = ggplot(tab_ct_reg, aes(x = Var2, y = time, 
                       size = Freq, alpha = Freq, colour = Var2))+
  facet_wrap(~ct, ncol = 6)+
  scale_colour_manual(values = reg_cols_simp)+
  geom_point()+
  labs(x = "Region", y = "Time", colour = "Region", 
       size = "Norm. proportion", alpha = "Norm. proportion")+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 7),
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        axis.title = element_text(size = 7),
        strip.text = element_text(size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6.5))

pdf("results/Div-seq/Divseq_results/proportion_region_majorct_time.pdf", height = 2.7, width = 7.5)
print(plt)
dev.off()
```



# Cell Type predictions
Load results from models

```{r}
all_pred_f = list.files("results/Div-seq/", pattern = "preds_")
all_pred_f = all_pred_f[grepl("rfc", all_pred_f) & grepl("CT", all_pred_f)]
# test set results
test_res = lapply(all_pred_f[grepl("ax.csv", all_pred_f)], 
                  function(x) read.csv(paste0("results/Div-seq/", x), header = T))
names(test_res) = unlist(lapply(strsplit(all_pred_f[grepl("ax.csv", all_pred_f)], ".", fixed = T),
                                function(x) x[1]))

# Div-seq results
div_res = lapply(all_pred_f[grepl("div", all_pred_f)], 
                 function(x) read.csv(paste0("results/Div-seq/", x), header = T))
names(div_res) = unlist(lapply(strsplit(all_pred_f[grepl("div", all_pred_f)], ".", fixed = T),
                               function(x) x[1]))
```

Plot predictions

```{r}
div_dat$pred_ctall = div_res$preds_rfc_CT_div_all$pred_rfc[match(colnames(div_dat), 
                                                                 div_res$preds_rfc_CT_div_all$X)]
div_dat$pred_ctneu = div_res$preds_rfc_CT_div_neu$pred_rfc[match(colnames(div_dat), 
                                                                 div_res$preds_rfc_CT_div_neu$X)]
div_dat$pred_ctneu[!(div_dat$high_level_anno %in% c("NPC", "neuronal"))] = NA
div_dat$pred_ctdif = div_res$preds_rfc_CT_div_dif$pred_rfc[match(colnames(div_dat), 
                                                                 div_res$preds_rfc_CT_div_dif$X)]
div_dat$pred_ctdif[!(div_dat$high_level_anno %in% c("neuronal"))] = NA
DimPlot(div_dat, reduction = "umap_harmony", group.by = "highlevel_clusters", label = T)
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_ctall")
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_ctneu")
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_ctdif")
```

Label smoothing

```{r}
div_dat = FindClusters(div_dat, resolution = c(2, 5, 10, 20, 25, 50), algorithm = 2, verbose = F)
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.2", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.5", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.10", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.20", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.25", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "RNA_snn_res.50", label = T)+NoLegend()

tab_overcl = table(div_dat$RNA_snn_res.20, div_dat$pred_ctall)
tab_overcl = tab_overcl/rowSums(tab_overcl)
apply(tab_overcl, 1, function(x) colnames(tab_overcl)[which.max(x)])
sort(table(apply(tab_overcl, 1, function(x) colnames(tab_overcl)[which.max(x)])))
sort(apply(tab_overcl, 1, max))
sum(apply(tab_overcl, 1, max)<.5)/nrow(tab_overcl)

df_overcl = data.frame(tab_overcl)
nomajdf = unique(df_overcl[df_overcl$Freq<.33,c(1,1)])
colnames(nomajdf) = colnames(df_overcl)[1:2]
majdf = df_overcl[df_overcl$Freq>=.33,1:2]
match_df = rbind(majdf, nomajdf[!(nomajdf$Var1 %in% majdf$Var1),])

div_dat$pred_smooth_20 = match_df$Var2[match(div_dat$RNA_snn_res.20, match_df$Var1)]
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_smooth_20", label = T)+NoLegend()
DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_ctall", label = T)+NoLegend()
```

Save new metadata

```{r}
meta_div_pred = div_dat@meta.data[,c("sample", "high_level_anno", "highlevel_clusters", 
                                     "pred_regs", "pred_ctall", "pred_smooth_20")]
write.csv(meta_div_pred, file = "results/Div-seq/divseq_predicted_metadata.csv", 
          col.names = T, row.names = T, quote = F)
```


## Dot plots
Region changes in major predicted cell types

```{r}
tab_ct_reg = table(meta_div_pred$sample,
                   paste0(meta_div_pred$pred_smooth_20, "..", meta_div_pred$pred_regs))
tab_ct_reg = data.frame(tab_ct_reg)

tab_ct_reg$time = unlist(lapply(strsplit(as.character(tab_ct_reg$Var1), "_"), 
                                function(x) paste0(x[1], "_wpi")))
tab_ct_reg$pred_reg = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[2]))
tab_ct_reg$pred_ct = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[1]))

largest_ct = c()
for(r in unique(tab_ct_reg$time)){ # get the x most frequent cell types/tp
  cc = tab_ct_reg$time==r
  tab_ct_reg$Freq[cc] = tab_ct_reg$Freq[cc]/sum(tab_ct_reg$Freq[cc])
  largest_ct = unique(c(largest_ct, 
                        tab_ct_reg$pred_ct[cc][order(tab_ct_reg$Freq[cc], decreasing = T)][1:8]))
  largest_ct = largest_ct[grepl("_", largest_ct)]
}

tab_ct_reg = tab_ct_reg[tab_ct_reg$pred_ct %in% largest_ct,]

for(r in unique(tab_ct_reg$pred_ct)){
  cc = tab_ct_reg$pred_ct==r
  tab_ct_reg$Freq[cc] = scales::rescale(tab_ct_reg$Freq[cc], c(0,1))
}

tab_ct_reg$time = factor(tab_ct_reg$time, 
                         levels = rev(c("1_wpi", "2_wpi", "4_wpi", "6_wpi", "8_wpi", "12_wpi")))
tab_ct_reg$pred_reg = factor(tab_ct_reg$pred_reg, levels = c("medial","dorsal","lateral"))

reg_cols_simp = c("medial" = "#52168D", "dorsal" = "#C56007", "lateral" = "#118392")

plt = ggplot(tab_ct_reg, aes(x = pred_reg, y = time, 
                       size = Freq, alpha = Freq, colour = pred_reg))+
  facet_wrap(~pred_ct, ncol = 6)+
  scale_colour_manual(values = reg_cols_simp)+
  geom_point()+
  labs(x = "Region", y = "Time", colour = "Region", 
       size = "Norm. proportion", alpha = "Norm. proportion")+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 7),
        axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
        axis.title = element_text(size = 7),
        strip.text = element_text(size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6.5))

pdf("results/Div-seq/Divseq_results/proportion_region_predct_time.pdf", height = 5, width = 7.5)
print(plt)
dev.off()
```

Scatterpie of previous plot

```{r}
tab_ct_reg = table(meta_div_pred$sample,
                   paste0(meta_div_pred$pred_smooth_20, "..", meta_div_pred$pred_regs))
tab_ct_reg = data.frame(tab_ct_reg)

tab_ct_reg$time = unlist(lapply(strsplit(as.character(tab_ct_reg$Var1), "_"), 
                                function(x) paste0(x[1], "_wpi")))
tab_ct_reg$pred_reg = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[2]))
tab_ct_reg$pred_ct = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[1]))

tab_ct_reg$prop = tab_ct_reg$Freq
largest_ct = c()
for(r in unique(tab_ct_reg$time)){ # get the x most frequent cell types/tp
  cc = tab_ct_reg$time==r
  tab_ct_reg$prop[cc] = tab_ct_reg$prop[cc]/sum(tab_ct_reg$prop[cc])
  largest_ct = unique(c(largest_ct, 
                        tab_ct_reg$pred_ct[cc][order(tab_ct_reg$prop[cc], decreasing = T)][1:8]))
  largest_ct = largest_ct[grepl("_", largest_ct)]
}

tab_ct_reg = tab_ct_reg[tab_ct_reg$pred_ct %in% largest_ct,]

tab_timect_reg = t(reshape2::dcast(pred_reg~time+pred_ct, value.var = "Freq", 
                                   data = tab_ct_reg, fill = 0))
colnames(tab_timect_reg) = tab_timect_reg[1,]
tab_timect_reg = data.frame(tab_timect_reg[-1,])
tab_timect_reg$time = unlist(lapply(strsplit(rownames(tab_timect_reg), "_wpi_"), 
                                    function(x) paste0(x[1], "_wpi")))
tab_timect_reg$ct = unlist(lapply(strsplit(rownames(tab_timect_reg), "_wpi_"), function(x) x[2]))
tab_timect_reg$dorsal = as.numeric(tab_timect_reg$dorsal)
tab_timect_reg$lateral = as.numeric(tab_timect_reg$lateral)
tab_timect_reg$medial = as.numeric(tab_timect_reg$medial)

tab_timect_reg = tab_timect_reg[tab_timect_reg$ct!="microglia_8",]

propstime = unlist(unname(tapply(apply(tab_timect_reg[,1:3], 1, sum), 
                                 tab_timect_reg$time, function(x) x/sum(x))))

tab_timect_reg$propstime = propstime[rownames(tab_timect_reg)]

for(r in unique(tab_timect_reg$ct)){
  cc = tab_timect_reg$ct==r
  tab_timect_reg$propstime[cc] = scales::rescale(tab_timect_reg$propstime[cc], c(0,1))
}

tab_timect_reg$gg = 1:nrow(tab_timect_reg)

tab_timect_reg$time = factor(tab_timect_reg$time, 
                             levels = c("1_wpi","2_wpi","4_wpi","6_wpi","8_wpi","12_wpi"))
tab_timect_reg$ct = factor(tab_timect_reg$ct, 
                           levels = rev(c("epen_clus_4", "epen_clus_3", "epen_clus_0",
                                      "npc_SUBSET_7","npc_SUBSET_8","npc_SUBSET_3",
                                      "npc_SUBSET_4","npc_SUBSET_10",
                                      "glut_SUBSET_10", "glut_SUBSET_3", "glut_SUBSET_1",
                                      "glut_SUBSET_4", "glut_SUBSET_0",
                                      "GABA_SUBSET_3","GABA_SUBSET_4",
                                      "GABA_SUBSET_1","GABA_SUBSET_14")))

scplt = ggplot()+
  geom_scatterpie(aes(x=as.numeric(time), y=as.numeric(ct), 
                      group=gg, r=propstime/2), data=tab_timect_reg,
                  cols=c("medial", "dorsal", "lateral"))+ 
  scale_x_continuous(labels = levels(tab_timect_reg$time),
                     breaks = 1:6)+
  scale_y_continuous(labels = levels(tab_timect_reg$ct),
                     breaks = 1:length(levels(tab_timect_reg$ct)))+
  scale_fill_manual(values = reg_cols_simp)+
  coord_equal()+
  labs(x = "time", y = "cell type", fill = "region")+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 6),
        axis.title = element_text(size = 6.5),
        legend.position = "none")

pdf("results/Div-seq/Divseq_results/proportion_region_predct_time_pie.pdf", height = 7.5, width = 3)
print(scplt)
dev.off()
```

Scatterpie of major cell types

```{r}
# count time vs ct..region
major_ct_pred = unlist(lapply(strsplit(meta_div_pred$pred_ctall, "_"), function(x) x[1]))
tab_ct_reg = table(meta_div_pred$sample,
                   paste0(major_ct_pred, "..", meta_div_pred$pred_regs))
tab_ct_reg = data.frame(tab_ct_reg)

# unravel
tab_ct_reg$time = unlist(lapply(strsplit(as.character(tab_ct_reg$Var1), "_"), 
                                function(x) paste0(x[1], "_wpi")))
tab_ct_reg$pred_reg = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[2]))
tab_ct_reg$pred_ct = unlist(lapply(strsplit(as.character(tab_ct_reg$Var2), "..", fixed = T), 
                                function(x) x[1]))

# get proportions
tab_ct_reg$prop = tab_ct_reg$Freq
for(r in unique(tab_ct_reg$time)){
  cc = tab_ct_reg$time==r
  tab_ct_reg$prop[cc] = tab_ct_reg$prop[cc]/sum(tab_ct_reg$prop[cc])
}

# get counts per region
tab_timect_reg = t(reshape2::dcast(pred_reg~time+pred_ct, value.var = "Freq", 
                                   data = tab_ct_reg, fill = 0))
colnames(tab_timect_reg) = tab_timect_reg[1,]
tab_timect_reg = data.frame(tab_timect_reg[-1,])

# unravel
tab_timect_reg$time = unlist(lapply(strsplit(rownames(tab_timect_reg), "_wpi_"), 
                                    function(x) paste0(x[1], "_wpi")))
tab_timect_reg$ct = unlist(lapply(strsplit(rownames(tab_timect_reg), "_wpi_"), function(x) x[2]))
tab_timect_reg$dorsal = as.numeric(tab_timect_reg$dorsal)
tab_timect_reg$lateral = as.numeric(tab_timect_reg$lateral)
tab_timect_reg$medial = as.numeric(tab_timect_reg$medial)

# proportions of cell type per time
propstime = unlist(unname(tapply(apply(tab_timect_reg[,1:3], 1, sum), 
                                 tab_timect_reg$time, function(x) x/sum(x))))
tab_timect_reg$propstime = propstime[rownames(tab_timect_reg)]

# scale the proportions per cell type
for(r in unique(tab_timect_reg$ct)){
  cc = tab_timect_reg$ct==r
  tab_timect_reg$propstime[cc] = scales::rescale(tab_timect_reg$propstime[cc], c(0,1))
}
tab_timect_reg$gg = 1:nrow(tab_timect_reg) #required for plot

tab_timect_reg$time = factor(tab_timect_reg$time, 
                             levels = c("1_wpi","2_wpi","4_wpi","6_wpi","8_wpi","12_wpi"))
tab_timect_reg$ct = factor(tab_timect_reg$ct, 
                           levels = rev(c("epen", "npc", "glut", "GABA","oligodendrocyte",
                                      "microglia", "endothelial")))

scplt = ggplot()+
  geom_scatterpie(aes(x=as.numeric(time), y=as.numeric(ct), 
                      group=gg, r=propstime/2), data=tab_timect_reg,
                  cols=c("medial", "dorsal", "lateral"))+ 
  scale_x_continuous(labels = levels(tab_timect_reg$time),
                     breaks = 1:6)+
  scale_y_continuous(labels = levels(tab_timect_reg$ct),
                     breaks = 1:length(levels(tab_timect_reg$ct)))+
  scale_fill_manual(values = reg_cols_simp)+
  coord_equal()+
  labs(x = "time", y = "cell type", fill = "region")+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 6),
        axis.title = element_text(size = 6.5),
        legend.position = "none")

# add global cell type proportions per region
prop_df = data.frame(prop.table(table(major_ct_pred, meta_div_pred$pred_regs)))
prop_df$major_ct_pred = factor(prop_df$major_ct_pred, levels = levels(tab_timect_reg$ct))

col_prop = ggplot()+
  geom_col(data = prop_df, mapping = aes(x = Freq, y = major_ct_pred, fill = Var2))+
  scale_x_continuous(expand = c(0,0), limits = c(0,.37))+
  scale_fill_manual(values = reg_cols_simp)+
  labs(x = "proportion")+
  theme_void()+
  theme(legend.position = "none",
        axis.line.y = element_line(),
        axis.text.x = element_text(colour = "black", size = 6, 
                                   angle = 30, vjust = 1, hjust = 1),
        axis.title.x = element_text(size = 6.5),
        axis.line.x = element_line(),
        axis.ticks.x = element_line())

pdf("results/Div-seq/Divseq_results/proportion_region_predct_time_pie_bar.pdf", 
    height = 3, width = 3.65)
scplt + col_prop + plot_layout(widths = c(1,0.2)) & theme(plot.margin = unit(c(0,0,0,0), "cm"))
dev.off()
```


## Barplots
Predicted cell type abundances

```{r}
tab_ctall = data.frame(table(meta_div_pred$sample,meta_div_pred$pred_ctall))
tab_ctall$majorct = unlist(lapply(strsplit(as.character(tab_ctall$Var2), "_"), function(x) x[1]))
tab_ctall$majorct = factor(tab_ctall$majorct, 
                           levels = c("epen", "npc", "glut", "GABA", "microglia",
                                      "oligodendrocyte", "endothelial"))
ctord = sort(table(meta_div_pred$pred_ctall))
tab_ctall$Var2 = factor(tab_ctall$Var2, levels = names(ctord))

pdf("results/Div-seq/Divseq_results/predCellType_abundance_timepoint.pdf", height = 9.5, width = 7.5)
ggplot(tab_ctall, aes(x = Freq, y = Var2, fill = Var1))+
  facet_grid(majorct~Var1, scales = "free", space = "free_y")+
  geom_col(colour = "grey50")+
  scale_x_continuous(expand = c(0,0))+
  scale_fill_manual(values = RColorBrewer::brewer.pal(6, "PuBuGn"))+
  theme_bw()+
  theme(axis.text.x = element_text(size = 6, colour = "black"),
        axis.text.y = element_text(size = 6.5, colour = "black"),
        strip.text = element_text(size = 6.5),
        legend.position = "none")
dev.off()

pdf("results/Div-seq/Divseq_results/predCellType_abundance_celltype.pdf", height = 9.5, width = 7.5)
ggplot(tab_ctall, aes(x = Freq, y = Var2, fill = Var2))+
  facet_grid(majorct~Var1, scales = "free", space = "free_y")+
  geom_col()+
  scale_x_continuous(expand = c(0,0))+
  scale_fill_manual(values = cols_cc)+
  theme_bw()+
  theme(axis.text.x = element_text(size = 6, colour = "black"),
        axis.text.y = element_text(size = 6.5, colour = "black"),
        strip.text = element_text(size = 6.5),
        legend.position = "none")
dev.off()
```

Predicted cell type abundances, with predicted region

```{r}
tab_ctall = data.frame(table(meta_div_pred$sample, 
                             paste0(meta_div_pred$pred_ctall, "..", meta_div_pred$pred_regs)))
tab_ctall$ct = unlist(lapply(strsplit(as.character(tab_ctall$Var2), "..", fixed = T), 
                             function(x) x[1]))
tab_ctall$reg = unlist(lapply(strsplit(as.character(tab_ctall$Var2), "..", fixed = T), 
                              function(x) x[2]))
tab_ctall$majorct = unlist(lapply(strsplit(as.character(tab_ctall$Var2), "_"), function(x) x[1]))
tab_ctall$majorct = factor(tab_ctall$majorct, 
                           levels = c("epen", "npc", "glut", "GABA", "microglia",
                                      "oligodendrocyte", "endothelial"))

ctord = sort(table(meta_div_pred$pred_ctall))
tab_ctall$ct = factor(tab_ctall$ct, levels = names(ctord))

pdf("results/Div-seq/Divseq_results/predCellType_abundance_predRegion.pdf", height = 9.5, width = 7.5)
ggplot(tab_ctall, aes(x = Freq, y = ct, fill = reg))+
  facet_grid(majorct~Var1, scales = "free", space = "free_y")+
  geom_col()+
  scale_x_continuous(expand = c(0,0))+
  scale_fill_manual(values = reg_cols_simp)+
  theme_bw()+
  theme(axis.text.x = element_text(size = 6, colour = "black"),
        axis.text.y = element_text(size = 6.5, colour = "black"),
        strip.text = element_text(size = 6.5),
        legend.position = "none")
dev.off()
```

Barplots for glut and NPC

```{r}
plot_df = meta_div_pred[,c(1,4,5)]
plot_df$sample[plot_df$sample=="1_wpi_pos"] = "1_wpi"
plot_df$sample = factor(plot_df$sample, levels = rev(paste0(c(1,2,4,6,8,12), "_wpi")))
plot_df$pred_regs = factor(plot_df$pred_regs, levels = c("medial", "dorsal", "lateral"))
for(i in c("glut_", "npc_")){
  sub_plot_df = plot_df[grepl(i, plot_df$pred_ctall),]
  sub_plot_df$pred_ctall = gsub(paste0(i, "SUBSET_"), "", sub_plot_df$pred_ctall)
  lvls = if(i=="glut_"){
    c(9,10,22,27,19,14,17,26,8,6,20,1,11,13,25,2,21,16,3,0,12,7,5,4,24,15,18)
  } else {c(2,13,0,14,1,3,9,4,11,7)}
  sub_plot_df = sub_plot_df[sub_plot_df$pred_ctall %in% as.character(lvls),]
  sub_plot_df$pred_ctall = factor(sub_plot_df$pred_ctall, 
                                  levels = as.character(lvls))
  limmax = max(table(sub_plot_df$pred_ctall))
  
  for(gg in c("sample", "pred_regs", "grey25")){
    cols_use = if(gg=="pred_regs"){
      reg_cols_simp
    } else if(gg=="sample"){
      rev(colorRampPalette(c("grey85", "#df16df"))(6))
    }
    plt = ggplot(sub_plot_df)+
      scale_y_continuous(expand = c(0,0), limits = c(0, limmax+0.05*limmax))+
      theme_classic()+
      theme(axis.text.x = element_text(colour = "black", size = 7),
            axis.text.y = element_text(colour = "black", size = 6),
            axis.title.x = element_blank(),
            axis.title.y = element_text(size = 7),
            legend.key.size = unit(0.4, "cm"),
            legend.text = element_text(size = 6),
            legend.title = element_text(size = 7))
    if(gg!="grey25"){
      plt = plt+geom_bar(mapping = aes_string(x = "pred_ctall", fill = gg))+
        scale_fill_manual(values = cols_use)
    } else{
      plt = plt+geom_bar(mapping = aes_string(x = "pred_ctall"), fill = gg)
    }
    pdf(paste0("results/Div-seq/barplots_glutnpc/bar_", i, gg, ".pdf"), width = 4.8, height = 1.25)
    print(plt)
    dev.off()
  }
}
```


## UMAPs
UMAP with predicted cell types

```{r}
plt = DimPlot(div_dat, reduction = "umap_harmony", group.by = "pred_ctall", shuffle = T)+
  scale_colour_manual(values = cols_cc)+
  theme(aspect.ratio = 1,
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        plot.title = element_blank(),
        legend.position = "none")

pdf("results/Div-seq/Divseq_results/divseq_umap_predct.pdf", height = 2.7, width = 2.7)
print(plt)
dev.off()
```


## Line plot
Line plot for major cell types

```{r}
majorct = sapply(strsplit(meta_div_pred$pred_ctall, "_"), function(x) x[1])
majorct[meta_div_pred$pred_ctall %in% c("epen_clus_4", "epen_clus_3")] = "epen_a"
majorct[meta_div_pred$pred_ctall %in% c("epen_clus_1", "epen_clus_13", 
                                        "epen_clus_7","epen_clus_14")] = "epen_n"
plot_df = reshape2::melt(prop.table(table(majorct, meta_div_pred$sample), margin = 2))
plot_df$Var2 = as.character(plot_df$Var2)
plot_df$Var2[plot_df$Var2=="1_wpi_pos"] = "1_wpi"
plot_df$Var2 = factor(plot_df$Var2, levels = c("1_wpi", "2_wpi", "4_wpi", 
                                               "6_wpi", "8_wpi", "12_wpi"))

cols_use = c(unname(cols_cc[grepl("epen", names(cols_cc))][c(1,15,8)]), "#6091ba", "#d05959",
             "#feb72a", "#E6530D", "#E43D88", "#712166")
names(cols_use) = c("epen_a", "epen_n", "epen_q", "glut", "GABA", "npc", 
                    "microglia", "oligodendrocyte", "endothelial")
ln_plt = ggplot(plot_df, aes(x = Var2, y = value, 
                    group = majorct, colour = majorct))+
  geom_point(size = 1)+
  geom_line()+
  scale_colour_manual(values = cols_use)+
  labs(x = "time (wpi)", y = "proportion per timepoint",
       colour = "major cell type\n(predicted)")+
  theme_classic()+
  theme(aspect.ratio = 1/2,
        axis.text = element_text(size = 7, colour = "black"),
        axis.title = element_text(size = 7.5),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 7.5),
        legend.key.size = unit(0.55, "cm"))

pdf("results/Div-seq/Divseq_results/divseq_majorct_lines.pdf", height = 3, width = 5)
print(ln_plt)
dev.off()
```



# DE 1 wpi vs other time points
Load data

```{r}
div_srat = readRDS("data/expression/axolotl_reclust/Edu_1_2_4_6_8_12_fil_highvarfeat.RDS")
meta_div_pred = read.csv("results/Div-seq/divseq_predicted_metadata.csv", 
                         header = T, row.names = 1)
div_srat = AddMetaData(div_srat, metadata = meta_div_pred)

div_srat$majorct = sapply(strsplit(div_srat$pred_ctall, "_"), function(x) x[1])
div_srat$majorct[div_srat$pred_ctall %in% c("epen_clus_3", "epen_clus_4")] = "epenAct"
div_srat$majorct[div_srat$pred_ctall %in% c("epen_clus_1", "epen_clus_14",
                                          "epen_clus_7", "epen_clus_13")] = "epenNeu"
div_srat$majorct[div_srat$pred_ctall %in% c("epen_clus_0", "epen_clus_2", "epen_clus_5",
                                          "epen_clus_6","epen_clus_8", "epen_clus_9",
                                          "epen_clus_10","epen_clus_11", "epen_clus_12")] = "epenQui"
```

DE 1 wpi vs each time point

```{r}
rest = unique(div_srat$sample)[unique(div_srat$sample)!="1_wpi_pos"]

ct_mk_l = list()
for(ct in unique(div_srat$pred_ctall)){
  sub_dat = div_srat[,div_srat$pred_ctall==ct]
  for(tp in rest){
    cond = sub_dat$sample %in% c(tp, "1_wpi_pos")
    if(sum(cond)>9){
      subsub_dat = sub_dat[,cond]
      if(length(unique(subsub_dat$sample))>1){
        ct_mk_l[[paste0(ct, "_", tp)]] = presto::wilcoxauc(subsub_dat, group_by = "sample")
      }
    }
  }
}
saveRDS(ct_mk_l, file = "results/Div-seq/rest_1wpi_celltype_DE.RDS")

mct_mk_l = list()
for(ct in unique(div_srat$majorct)){
  sub_dat = div_srat[,div_srat$majorct==ct]
  for(tp in rest){
    cond = sub_dat$sample %in% c(tp, "1_wpi_pos")
    if(sum(cond)>9){
      subsub_dat = sub_dat[,cond]
      if(length(unique(subsub_dat$sample))>1){
        mct_mk_l[[paste0(ct, "_", tp)]] = presto::wilcoxauc(subsub_dat, group_by = "sample")
      }
    }
  }
}
saveRDS(mct_mk_l, file = "results/Div-seq/rest_1wpi_majorct_DE.RDS")
```

Filter the DE genes to those significant and meaningful

```{r}
ct_mk_l_filt = list()
for(n in names(ct_mk_l)){
  ct_mk_l_filt[[n]] = ct_mk_l[[n]][ct_mk_l[[n]]$padj<=0.05 & ct_mk_l[[n]]$logFC>=0.2,]
  ct_mk_l_filt[[n]] = ct_mk_l_filt[[n]][!startsWith(ct_mk_l_filt[[n]]$feature, "AMEX") &
                                        !startsWith(ct_mk_l_filt[[n]]$feature, "LOC") &
                                        !grepl("..", ct_mk_l_filt[[n]]$feature, fixed = T),]
}

mct_mk_l_filt = list()
for(n in names(mct_mk_l)){
  mct_mk_l_filt[[n]] = mct_mk_l[[n]][mct_mk_l[[n]]$padj<=0.05 & mct_mk_l[[n]]$logFC>=0.2,]
  mct_mk_l_filt[[n]] = mct_mk_l_filt[[n]][!startsWith(mct_mk_l_filt[[n]]$feature, "AMEX") &
                                        !startsWith(mct_mk_l_filt[[n]]$feature, "LOC") &
                                        !grepl("..", mct_mk_l_filt[[n]]$feature, fixed = T),]
}
```

Get GO Terms, without repeated genes

```{r}
bg = rownames(div_srat)[rowSums(div_srat@assays$RNA@data)>0]
bg = bg[!startsWith(bg, "AMEX") & !startsWith(bg, "LOC") & !grepl("..", bg, fixed = T)]

go_mct_l2 = list()
for(ct in names(mct_mk_l_filt)){
  for(g in unique(mct_mk_l_filt[[ct]]$group)){
    id = paste0(ct, "..", g)
    genes = mct_mk_l_filt[[ct]]$feature[mct_mk_l_filt[[ct]]$group==g]

    if(length(genes)>0){
      go_mct_l2[[id]] = gprofiler2::gost(genes, ordered_query = F, sources="GO:BP",
                                         custom_bg = bg)$result
    }
  }
}
```

Plotting

```{r, fig.height=3, fig.width=3}
for(n in names(go_mct_l2)){
  plot_df = head(go_mct_l2[[n]], 10)
  plot_df$term_name = factor(plot_df$term_name, levels = rev(plot_df$term_name))
  m = -log10(plot_df$p_value)+(-log10(plot_df$p_value)*0.05)
  plt = ggplot(plot_df, aes(x = -log10(p_value), y = term_name))+
    geom_col()+
    ggtitle(n)+
    scale_x_continuous(expand = c(0,0), limits = c(0, m))+
    theme_bw()+
    theme(axis.text = element_text(colour = "black", size = 7))
  print(plt)
}
```


```{r}
#View(go_mct_l2$epenAct_12_wpi..12_wpi)
gostres = gprofiler2::gconvert(query = c("GO:0051674"), 
                               target = "HGNC", organism = "hsapiens")$target
loc_genes = lapply(mct_mk_l_filt[grepl("epenAct", names(mct_mk_l_filt))], 
                   function(x) gostres[gostres %in% x$feature[x$group=="1_wpi_pos"]])
loc_genes = unique(unlist(loc_genes))

res_mat = matrix(0, nrow = length(loc_genes), ncol = sum(grepl("epenAct", names(mct_mk_l))))
rownames(res_mat) = loc_genes
colnames(res_mat) = names(mct_mk_l)[grepl("epenAct", names(mct_mk_l))]
for(n in names(mct_mk_l)[grepl("epenAct", names(mct_mk_l))]){
  fc = mct_mk_l[[n]][mct_mk_l[[n]]$group=="1_wpi_pos", ]
  res_mat[,n] = fc[match(loc_genes, fc$feature),"logFC"]
}

annot_df = data.frame(row.names = rownames(res_mat),
                      "cor" = apply(res_mat, 1, function(x) cor(x, 1:5)),
                      "abscor" = abs(apply(res_mat, 1, function(x) cor(x, 1:5))))
pheatmap::pheatmap(res_mat, cluster_cols = F, clustering_method = "ward.D", 
                   treeheight_row = 40, fontsize = 7, annotation_row = annot_df)
boxplot(sort(annot_df$cor))
```



```{r}
#sub_dat = div_srat[,div_srat$majorct=="epenAct"]
sub_dat = div_srat[,grepl("epen", div_srat$majorct)]
sub_dat = NormalizeData(sub_dat)
sub_dat = FindVariableFeatures(sub_dat, nfeatures = 10000)
sub_dat = ScaleData(sub_dat, vars.to.regress = c("nCount_RNA", "percent.mt", "batch"))
sub_dat = RunPCA(sub_dat, features = rownames(sub_dat), verbose = F)

DimPlot(sub_dat, dims = 1:2, reduction = "pca", group.by = "sample")

g = rownames(sub_dat@assays$RNA@counts)
g = g[!startsWith(g, "AMEX") & !startsWith(g, "LOC") & !grepl("..", g, fixed = T)]

library(fastTopics)
fit = fit_topic_model(Matrix::t(sub_dat@assays$RNA@counts[g,]), k = 10)
fit7 = fit_topic_model(Matrix::t(sub_dat@assays$RNA@counts[g,]), k = 7)
fit4 = fit_topic_model(Matrix::t(sub_dat@assays$RNA@counts[g,]), k = 4)

topic_colors = rainbow(10)
structure_plot(fit, colors = topic_colors, topics = 1:10, gap = 25,
               grouping = factor(sub_dat$pred_ctall))
structure_plot(fit, colors = topic_colors, topics = 1:10, gap = 25,
               grouping = factor(sub_dat$sample))
structure_plot(fit, colors = topic_colors, topics = 1:10, gap = 25,
               grouping = factor(sub_dat$batch))

dfa_out = fastTopics::de_analysis(fit4, Matrix::t(sub_dat@assays$RNA@counts[rownames(fit4$F),]))
volcano_plot(dfa_out,k = 4,labels = rownames(fit4$F))

tp = factor(sub_dat$sample, levels = c("1_wpi_pos", "2_wpi", "4_wpi", "6_wpi", "8_wpi", "12_wpi"))
pca_plot(fit,fill = tp) +
  scale_fill_manual(values = RColorBrewer::brewer.pal(7, "BuPu")[-1])

#pca = prcomp(fit4$L)$x
pca = prcomp(fit$L)$x
df = data.frame(pc = pca[,1][pca[,2]>0], tp = tp[pca[,2]>0])
boxplot(pc~tp, df)
cond = pca[,1]>(-0.25)
cor_pc1 = t(cor(pca[,2][cond], as.matrix(Matrix::t(sub_dat@assays$RNA@counts[rownames(fit$F),cond]))))
cor_pc1 = cor_pc1[!is.na(cor_pc1),,drop = F]
cor_filt = cor_pc1[abs(cor_pc1)>=0.25,,drop = F]

View(cor_filt)
```


```{r}
bg = rownames(fit$F)
genes = rownames(cor_filt)[cor_filt[,1]>0]
go_cor_pos = gprofiler2::gost(genes, ordered_query = F, sources="GO:BP", custom_bg = bg)$result
plot_df = head(go_cor_pos, 10)
plot_df$term_name = factor(plot_df$term_name, levels = rev(plot_df$term_name))
m = -log10(plot_df$p_value)+(-log10(plot_df$p_value)*0.05)
plt = ggplot(plot_df, aes(x = -log10(p_value), y = term_name))+
  geom_col()+
  ggtitle("positively cor")+
  scale_x_continuous(expand = c(0,0), limits = c(0, m))+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 7))


genes = rownames(cor_filt)[cor_filt[,1]<0]
go_cor_neg = gprofiler2::gost(genes, ordered_query = F, sources="GO:BP", custom_bg = bg)$result
plot_df = head(go_cor_neg, 10)
plot_df$term_name = factor(plot_df$term_name, levels = rev(plot_df$term_name))
m = -log10(plot_df$p_value)+(-log10(plot_df$p_value)*0.05)
plt = ggplot(plot_df, aes(x = -log10(p_value), y = term_name))+
  geom_col()+
  ggtitle("negatively cor")+
  scale_x_continuous(expand = c(0,0), limits = c(0, m))+
  theme_bw()+
  theme(axis.text = element_text(colour = "black", size = 7))
```



# Integrating SS and all wpi (pos) - ependymal only
Load data

```{r}
#steady-state
ax_srat = readRDS("data/expression/axolotl_reclust/all_nuclei_clustered_highlevel_anno.RDS")
meta = read.csv("data/annotations/axolotl_all_umeta.csv", 
                header = T, row.names = 1)
ax_srat = AddMetaData(ax_srat, metadata = meta)
meta_regs = read.csv("data/processed/multiome/WP_region_predictions.csv", 
                    header = T, row.names = 1)
newcellnames = rownames(meta_regs)
newcellnames = gsub("-a1-1", "-1_1", newcellnames)
newcellnames = gsub("-a1-2", "-1_2", newcellnames)
newcellnames = gsub("-a3-1", "-1_3", newcellnames)
newcellnames = gsub("-a3-2", "-1_4", newcellnames)
rownames(meta_regs) = newcellnames
ax_srat = AddMetaData(ax_srat, metadata = meta_regs)
ax_srat$regions_all = ax_srat$pred_regions_top
ax_srat$regions_all[is.na(ax_srat$regions_all)] = ax_srat$regions[is.na(ax_srat$regions_all)]

meta_ss_simp = ax_srat@meta.data[,c("sample", "chem", "seurat_clusters", "classes", "subclasses", 
                                    "cellclusters", "regions", "pred_regions_top", "regions_all")]
write.csv(meta_ss_simp, file = "results/Div-seq/pallium_metadata_simp.csv", 
          col.names = T, row.names = T, quote = F)

# div-seq
div_srat = readRDS("data/expression/axolotl_reclust/Edu_1_2_4_6_8_12_fil_highvarfeat.RDS")
meta_div_pred = read.csv("results/Div-seq/divseq_predicted_metadata.csv", 
                         header = T, row.names = 1)
div_srat = AddMetaData(div_srat, metadata = meta_div_pred)
```

Merge datasets

```{r}
# filter metadata
ax_srat@meta.data = ax_srat@meta.data[,c("nCount_RNA", "nFeature_RNA", "percent.mt", "chem", "high_level_anno", "cellclusters", "regions_all", "chem")]
colnames(ax_srat@meta.data)[4] = "sample"
colnames(ax_srat@meta.data)[8] = "batch"
div_srat@meta.data = div_srat@meta.data[,c("nCount_RNA", "nFeature_RNA", "percent.mt", "sample", "seurat_clusters", "pred_ctall", "pred_regs", "batch"), drop = F]

ax_1wpi_srat = merge(ax_srat, div_srat)
ep_wpi_srat = ax_1wpi_srat[,grepl("epen_", ax_1wpi_srat$pred_ctall) |
                             grepl("epen_", ax_1wpi_srat$cellclusters)]
```

Joint processing

```{r}
ep_wpi_srat$sample_dat = ep_wpi_srat$sample
ep_wpi_srat$sample_dat[grepl("wpi", ep_wpi_srat$sample_dat)] = "div"
ep_wpi_srat = NormalizeData(ep_wpi_srat)
ep_wpi_srat = FindVariableFeatures(ep_wpi_srat, nfeatures = 10000)
ep_wpi_srat = ScaleData(ep_wpi_srat, 
                         vars.to.regress = c("nCount_RNA", "percent.mt", "batch"))
ep_wpi_srat = RunPCA(ep_wpi_srat, verbose = F)
ElbowPlot(ep_wpi_srat, ndims = 50)
```

Run UMAP

```{r}
ep_wpi_srat = RunUMAP(ep_wpi_srat, dims = 1:15, verbose = F)
UMAPPlot(ep_wpi_srat, group.by = "sample_dat")
UMAPPlot(ep_wpi_srat, group.by = "cellclusters")
```

Integrate with Harmony based on multiome/v3.1/div-seq

```{r}
ep_wpi_srat@reductions$harmony = NULL
ep_wpi_srat@reductions$umap_harmony = NULL
# Run Harmony
ep_wpi_srat = harmony::RunHarmony(ep_wpi_srat, group.by.vars = "batch", 
                                   tau = 30, sigma = 0.1,
                                   plot_convergence = F, assay.use = "RNA", verbose = F)

# Run UMAP on Harmony dimentions
ep_wpi_srat = RunUMAP(ep_wpi_srat, reduction = "harmony", 
                      dims = 1:30, reduction.name = "umap_harmony", verbose = F)
```

Check integration

```{r}
ep_wpi_srat$sample_simp = ep_wpi_srat$sample
ep_wpi_srat$sample_simp[!grepl("wpi", ep_wpi_srat$sample_simp)] = "SS"
ep_wpi_srat$sample_simp[ep_wpi_srat$sample_simp=="1_wpi_pos"] = "1_wpi"
ep_wpi_srat$sample_simp[ep_wpi_srat$sample_simp=="1_wpi_neg"] = "1_wpi"
xxx = factor(ep_wpi_srat$sample_simp, levels = c("SS", paste0(c(1,2,4,6,8,12), "_wpi")))
ep_wpi_srat$sample_simp = xxx

ep_wpi_srat$ctlabels = ep_wpi_srat$cellclusters
ep_wpi_srat$ctlabels[is.na(ep_wpi_srat$ctlabels)] = ep_wpi_srat$pred_ctall[is.na(ep_wpi_srat$ctlabels)]
ep_wpi_srat$reglabels = ep_wpi_srat$regions_all
ep_wpi_srat$reglabels[is.na(ep_wpi_srat$reglabels)] = ep_wpi_srat$pred_regs[is.na(ep_wpi_srat$reglabels)]

DimPlot(ep_wpi_srat, group.by = "ctlabels", reduction = "umap_harmony", 
        label = T, split.by = "sample_simp")+NoLegend()
DimPlot(ep_wpi_srat, group.by = "sample_simp", reduction = "umap_harmony", label=T)
```

Clustering

```{r}
ep_wpi_srat = FindNeighbors(ep_wpi_srat, reduction = "harmony", 
                            dims = 1:30, graph.name = "integEp")
ep_wpi_srat = FindClusters(ep_wpi_srat, resolution = c(0.8, 1, 1.2, 1.5, 2, 2.5, 3, 5), 
                           graph.name = "integEp", algorithm = 2, verbose = F)

DimPlot(ep_wpi_srat, group.by = "integEp_res.1.5", 
        reduction = "umap_harmony", label = T)+NoLegend()
DimPlot(ep_wpi_srat, group.by = "ctlabels", 
        reduction = "umap_harmony", label = T)+NoLegend()

ep_wpi_srat = CellCycleScoring(ep_wpi_srat, 
                               g2m.features = cc.genes$g2m.genes, s.features = cc.genes$s.genes)

DimPlot(ep_wpi_srat, group.by = "Phase", 
        reduction = "umap_harmony", label = T)+NoLegend()
```

Save data

```{r}
ep_wpi_srat@meta.data$clusters_used = ep_wpi_srat@meta.data$integEp_res.1.5
saveRDS(ep_wpi_srat, file = "results/Div-seq/ep_wpi_srat.RDS")
```

Plot UMAPs

```{r, fig.height=2.5, fig.width=2.5}
ep_wpi_srat$ep_type = ep_wpi_srat$ctlabels
ep_wpi_srat$ep_type[ep_wpi_srat$ep_type %in% c("epen_clus_4", "epen_clus_3")] = "active ependymal"
ep_wpi_srat$ep_type[ep_wpi_srat$ep_type %in% c("epen_clus_1", "epen_clus_7",
                                               "epen_clus_14", "epen_clus_13")] = "pro-neuronal ependymal"
ep_wpi_srat$ep_type[ep_wpi_srat$ep_type %in% c("epen_clus_0", "epen_clus_2", "epen_clus_12",
                                                 "epen_clus_8", "epen_clus_6", "epen_clus_5",
                                                 "epen_clus_9", "epen_clus_10", "epen_clus_11")] = "quiescent ependymal"

col_list = list(ctlabels = cols_cc, 
                ep_type = unname(cols_cc[grepl("epen", names(cols_cc))][c(1,15,8)]),
                Phase = MetBrewer::met.brewer(name="Egypt", n=3, type = "discrete"),
                integEp_res.1.5 = MetBrewer::met.brewer(name="Klimt",
                                                      n=length(unique(ep_wpi_srat@meta.data$integEp_res.1.5)),
                                                      type = "continuous"),
                reglabels = reg_cols)
csfunc = colorRampPalette(c("#df16df", "#ffd9f9"))
col_list$sample_simp = c("gray80", csfunc(6))
names(col_list$sample_simp) = c("SS", paste0(c(1,2,4,6,8,12), "_wpi"))

plt_umap_l = list()
for(v in c("integEp_res.1.5", "ctlabels", "ep_type", "Phase", "sample_simp", "reglabels")){
  pal_plt = col_list[[v]]
  
  plot_df = Embeddings(ep_wpi_srat, reduction = "umap_harmony")
  plot_df = merge(plot_df, ep_wpi_srat@meta.data, by = 0)
  plot_df = plot_df[order(plot_df$sample_simp, decreasing = F),]
  
  lab_df = plot_df[,c("umap_harmony_1","umap_harmony_2",v)]
  c1 = tapply(lab_df$umap_harmony_1, lab_df[,v], median)
  c2 = tapply(lab_df$umap_harmony_2, lab_df[,v], median)
  lab_df = data.frame(c1, c2, names(c1))
  colnames(lab_df) = c("umap_harmony_1","umap_harmony_2",v)
  
  plt_umap_l[[v]] = ggplot() + 
    geom_point(data = plot_df, 
               mapping = aes_string(x = "umap_harmony_1", y = "umap_harmony_2", colour = v),
               size = 0.7)+
    geom_label(data = lab_df, 
               mapping = aes_string(x = "umap_harmony_1", y = "umap_harmony_2", label = v),
               size = 2.7, label.padding = unit(0.1, "lines"))+
    scale_colour_manual(values = pal_plt)+
    theme_void()+
    theme(plot.title = element_blank(),
          legend.position = "none",
          aspect.ratio = 1, 
          axis.title = element_blank(), 
          axis.ticks = element_blank(), 
          axis.text = element_blank(), 
          axis.line = element_blank())
}

for(n in names(plt_umap_l)){
  pdf(paste0("results/Div-seq/ep_wpi_srat_", n, ".pdf"), height = 4, width = 4)
  print(plt_umap_l[[n]])
  dev.off()
}

pdf(paste0("results/Div-seq/ep_wpi_srat_", v, "_legend.pdf"), height = 1, width = 0.7)
cowplot::plot_grid(cowplot::get_legend(plt))
dev.off()
```

Check differences in proportions

```{r}
cl = "integEp_res.1.5"
dat = prop.table(table(ep_wpi_srat@meta.data[,cl], ep_wpi_srat$ep_type), margin = 1)
dat2 = prop.table(table(ep_wpi_srat@meta.data[,cl], ep_wpi_srat$reglabels), margin = 1)

annot = data.frame("top_cl" = apply(dat, 1, function(x) colnames(dat)[which.max(x)]),
                   "top_reg" = apply(dat2, 1, function(x) colnames(dat2)[which.max(x)]))

cols = unname(cols_cc[grepl("epen", names(cols_cc))][c(1,15,8)])
names(cols) = c("active ependymal", "quiescent ependymal", "pro-neuronal ependymal")
cols = list("top_cl" =  cols,
            "top_reg" = reg_cols_simp)
xxx = as.character(ep_wpi_srat$sample_simp)
xxx[ep_wpi_srat$sample=="1_wpi_neg"] = "1_wpi_neg"
dat = prop.table(table(xxx, ep_wpi_srat@meta.data[,cl]), margin = 2)
colpal = viridis::magma(100)
dat[dat<=0.03] = 0

plt_dat = dat[c(1,3:6,2,7),]
plt_dat = apply(plt_dat, 2, function(x) x/table(ep_wpi_srat$sample_simp)[rownames(plt_dat)])

pdf(paste0("results/Div-seq/ep_wpi_srat_clusterProport.pdf"), height = 2.25, width = 5.25)
pheatmap::pheatmap(plt_dat, clustering_method = "ward.D", annotation_col = annot, 
                   color = colpal, fontsize = 7, 
                   annotation_colors = cols, cluster_rows = F, treeheight_col = 0)
dev.off()
```

Get markers

```{r}
# all clusters
mk_cl = presto::wilcoxauc(ep_wpi_srat, group_by = "integEp_res.1.5")
saveRDS(mk_cl, file = "results/Div-seq/ep_wpi_srat_res1.5_DE.RDS")

mk_cl = mk_cl[!startsWith(mk_cl$feature, "AMEX") &
                !startsWith(mk_cl$feature, "LOC") &
                !grepl("..", mk_cl$feature, fixed = T),]
mk_cl$group = factor(mk_cl$group)
bg_g = unique(mk_cl$feature)
mk_cl = mk_cl[mk_cl$padj<=0.05 & mk_cl$logFC>=0.3,]

write.csv(mk_cl, file = "results/Div-seq/ep_wpi_srat_res1_DE.csv", quote = F, row.names = T)

# pro-neuronal ependymal only
mk_proneu = presto::wilcoxauc(ep_wpi_srat[,ep_wpi_srat$integEp_res.1 %in% c(5,6,12,15)],
                              group_by = "integEp_res.1")
mk_proneu = mk_proneu[!startsWith(mk_proneu$feature, "AMEX") &
                !startsWith(mk_proneu$feature, "LOC") &
                !grepl("..", mk_proneu$feature, fixed = T),]
mk_proneu$group = factor(mk_proneu$group)
mk_proneu = mk_proneu[mk_proneu$padj<=0.05,]
mk_proneu = mk_proneu[mk_proneu$pct_in-mk_proneu$pct_out>=20 & mk_proneu$logFC>=0.3,]
saveRDS(mk_proneu, file = "results/Div-seq/ep_wpi_srat_proneuro_DE.RDS")

# timepoint
ep_wpi_srat$sample_coarse = as.character(ep_wpi_srat$sample_simp)
ep_wpi_srat$sample_coarse[ep_wpi_srat$sample_coarse %in% c("4_wpi", "6_wpi")] = "mid_wpi"
ep_wpi_srat$sample_coarse[ep_wpi_srat$sample_coarse %in% c("8_wpi", "12_wpi")] = "late_wpi"
mk_wpi = presto::wilcoxauc(ep_wpi_srat, group_by = "sample_coarse")
mk_wpi = mk_wpi[!startsWith(mk_wpi$feature, "AMEX") &
                !startsWith(mk_wpi$feature, "LOC") &
                !grepl("..", mk_wpi$feature, fixed = T),]
mk_wpi$group = factor(mk_wpi$group)
mk_wpi = mk_wpi[mk_wpi$padj<=0.05 & mk_wpi$logFC>=0.3,]
saveRDS(mk_wpi, file = "results/Div-seq/ep_wpi_srat_time_DE.RDS")

# SS vs 1wpi per cluster
ss1wpi_de = list()
for(cl in unique(ep_wpi_srat$integEp_res.1.5)){
  sub_dat = ep_wpi_srat[,ep_wpi_srat$sample_simp %in% c("SS", "1_wpi")]
  sub_dat = sub_dat[,sub_dat$integEp_res.1.5==cl]
  if(sum(table(sub_dat$sample_simp)>0)==2){
    mk_sub = presto::wilcoxauc(sub_dat, group_by = "sample_simp")
    mk_sub = mk_sub[!startsWith(mk_sub$feature, "AMEX") &
                    !startsWith(mk_sub$feature, "LOC") &
                    !grepl("..", mk_sub$feature, fixed = T),]
    mk_sub$group = factor(mk_sub$group)
    ss1wpi_de[[cl]] = mk_sub[mk_sub$padj<=0.05,]
  }
}
saveRDS(ss1wpi_de, file = "results/Div-seq/ep_wpi_srat_ss1wpicl_DE.RDS")
```

Dotplots and heatmaps

```{r}
df = mk_cl %>% 
  group_by(group) %>% 
  top_n(5, wt = logFC)

g = unique(df$feature)

avg = AverageExpression(ep_wpi_srat, features = g, group.by = "integEp_res.1.5")$RNA
hc = hclust(dist(t(avg)), method = "ward.D")
hc = hc$labels[hc$order]

ep_wpi_srat$integEp_res.1.5 = factor(ep_wpi_srat$integEp_res.1.5, levels = hc)
mk_cl$group = factor(mk_cl$group, levels = hc)

df = mk_cl %>% 
  group_by(group) %>% 
  top_n(5, wt = logFC)

g = unique(df$feature[order(df$group)])

DotPlot(ep_wpi_srat, features = rev(g), group.by = "integEp_res.1.5", 
        dot.scale = 3,dot.min = 0.1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 7),
        axis.text.y = element_text(size = 7))

mks = c("RUNX1", "KAZALD1", "COL7A1", "ANXA2", "PLAT", "ERBB3", "DNAH1", "TUBB4B", "WNT8B")
avg = AverageExpression(ep_wpi_srat, features = mks, group.by = "integEp_res.1.5")$RNA

colpal = viridis::magma(100)
plot_dat = scale(t(avg))

pdf(paste0("results/Div-seq/ep_wpi_srat_mkheat.pdf"), height = 2.25, width = 5.25)
pheatmap::pheatmap(plot_dat, clustering_method = "ward.D", 
                   color = colpal, fontsize = 7, treeheight_row = F, treeheight_col = F)
dev.off()


FeaturePlot(ep_wpi_srat, reduction = "umap_harmony", features = mks, order = F)


avg = AverageExpression(ep_wpi_srat, features = mks, group.by = "integEp_res.1.5")$RNA
hc_cl = hclust(dist(scale(t(avg))), method = "ward.D")
hc_cl = hc_cl$labels[hc_cl$order]
hc_g = hclust(dist(avg), method = "ward.D")
hc_g = hc_g$labels[hc_g$order]

ep_wpi_srat$integEp_res.1.5 = factor(ep_wpi_srat$integEp_res.1.5, 
                                     levels = c(1,17,22,13,4,14,6,15,9,12,11,
                                                0,2,8,20,21,18,7,19,5,10,16,3))
dotplt = DotPlot(ep_wpi_srat, features = hc_g, group.by = "integEp_res.1.5", 
        dot.scale = 3, dot.min = 0.05)+
  scale_colour_viridis_c(option = 1, end = 0.9)+
  coord_flip()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 7),
        axis.text.y = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6))

pdf(paste0("results/Div-seq/ep_wpi_srat_mkdot.pdf"), height = 1.6, width = 4.4)
print(dotplt)
dev.off()
pdf(paste0("results/Div-seq/ep_wpi_srat_mkdot_legend.pdf"), height = 2.7, width = 0.9)
print(cowplot::plot_grid(cowplot::get_legend(dotplt)))
dev.off()
ep_wpi_srat$integEp_res.1.5 = factor(ep_wpi_srat$integEp_res.1.5, levels = rev(hc_cl))
dotplt = DotPlot(ep_wpi_srat, features = hc_g, group.by = "integEp_res.1.5", 
        dot.scale = 3, dot.min = 0.05)+
  scale_colour_viridis_c(option = 1, end = 0.9)+
  coord_flip()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 7),
        axis.text.y = element_text(size = 7),
        axis.title = element_text(size = 7),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6))
pdf(paste0("results/Div-seq/ep_wpi_srat_mkdot_clust.pdf"), height = 1.6, width = 4.4)
print(dotplt)
dev.off()
```

GO Terms

```{r}
go_l = list()
for(cl in unique(mk_cl$group)){
  g = mk_cl$feature[mk_cl$logFC>0.3 & mk_cl$group==cl]
  go_l[[paste0("cl", cl)]] = gprofiler2::gost(g, custom_bg = bg_g, sources = "GO",
                                              correction_method = "fdr")
}
saveRDS(go_l, file = "results/Div-seq/ep_wpi_srat_goDE.RDS")
```

Plot top 10 GO Terms (clustered by similarity)

```{r}
library(GOSemSim)
hsGO <- godata('org.Hs.eg.db', ont="BP")

top_go_l = list()
for(n in names(go_l)){
  cond = grepl("BP", go_l[[n]]$result$source) & go_l[[n]]$result$p_value<=0.01
  match = mgoSim(go_l[[n]]$result$term_id[cond], go_l[[n]]$result$term_id[cond], 
                 semData=hsGO, measure="Wang", combine=NULL)
  #pheatmap::pheatmap(match, clustering_method = "ward.D")
  if(!is.na(match)){
    if(dim(match)[1]>1){
      hc = hclust(dist(match), method = "ward.D")
      cut_18 = cutree(hc, ifelse(ncol(match)>10, 10, ncol(match)))
      t_l = c()
      for(i in unique(cut_18)){
        tt = names(cut_18)[cut_18==i]
        sub_res = go_l[[n]]$result[go_l[[n]]$result$term_id %in% tt & 
                                     go_l[[n]]$result$intersection_size>10,]
        sub_res = sub_res[order(sub_res$recall, decreasing = T),]
        t_l = c(t_l, sub_res$term_name[1])
      }
      
      top_go_l[[n]] = go_l[[n]]$result[go_l[[n]]$result$term_name %in% t_l,]
    }
  }
}
write.csv(top_go_l$cl21[,1:13], file = "results/Div-seq/cluster21_summarised_GO.csv", 
          row.names = F, col.names = T, quote = F)

breakStr = function(s, n = 20) {
  x = gsub(paste0('(.{1,',as.character(n),'})(\\s|$)'), '\\1\n', s)
  x = substr(x, 1, nchar(x)-1)
  return(x)
}
plt_go_l = list()
for(n in names(top_go_l)){
  plot_df = top_go_l[[n]][,c("term_name", "p_value")]
  plot_df$term_name = breakStr(plot_df$term_name, 25)
  plot_df = plot_df[order(plot_df$p_value, decreasing = F),]
  plot_df$term_name = factor(plot_df$term_name, levels = rev(plot_df$term_name))
  
  mval = max(-log10(plot_df$p_value))
  plt_go_l[[n]] = ggplot(plot_df, aes(x = -log10(p_value), y = term_name))+
    geom_col()+
    scale_x_continuous(expand = c(0,0), limits = c(0, mval+mval*0.05))+
    theme_bw()+
    theme(axis.text = element_text(colour = "black"))
  
  pdf(paste0("results/Div-seq/ep_wpi_srat_GO/ep_wpi_srat_", n, "_GO.pdf"), 
      height = 3.5, width = 4.5)
  print(plt_go_l[[n]])
  dev.off()
}
```

List genes per GO Term

```{r}
gene_term_cl = list()
for(n in names(top_go_l)){
  go_id = unique(top_go_l[[n]]$term_id)
  gene_term = gprofiler2::gconvert(query = go_id, organism = "hsapiens",
                                   target = "HGNC", filter_na = TRUE)[,c("input", "target")]
  
  if(!is.null(gene_term)){
    cl = gsub("cl", "", n)
    g = mk_cl$feature[mk_cl$group==cl]
    gene_term_cl[[n]] = gene_term[gene_term[,"target"] %in% g,]
    gene_term_cl[[n]] = merge(gene_term_cl[[n]], top_go_l[[n]][,c("term_id", "term_name")],
                              by = 1)
    
    #gg = mk_cl[mk_cl$group==cl,c("feature", "logFC")]
    gg = mk_cl[,c("feature", "logFC")]
    gene_term_cl[[n]] = merge(gene_term_cl[[n]], gg, by.x = 2, by.y = 1)
  }
}
saveRDS(gene_term_cl, file = "results/Div-seq/gene_term_cl_ep_wpi.RDS")
```

Groups of terms and genes per time point

```{r}
terms = c("collagen fibril organization", "wound healing", "cilium assembly", 
          "nuclear chromosome segregation", "positive regulation of cell adhesion",
          "neurotransmitter transport")

allt = Reduce(rbind, gene_term_cl)
g = unique(allt[allt$term_name %in% terms,c(1,3:4)])
g = g[order(g$logFC, decreasing = T),]
g = g[!duplicated(g$target),]

mean_exp = AverageExpression(ep_wpi_srat, group.by = "sample_simp", 
                             features = unique(g$target))$RNA
g$entropy = apply(mean_exp, 1, entropy::entropy)[g$target]

df = g %>% 
  group_by(term_name) %>% 
  top_n(10, wt = -entropy)

mean_exp = AverageExpression(ep_wpi_srat, group.by = "sample_simp", features = df$target)$RNA
mean_exp = t(scale(t(mean_exp)))
hc = hclust(dist(mean_exp), method = "ward.D")
#mean_exp[mean_exp>2.5] = 2.5
#mean_exp[mean_exp<(-2.5)] = -2.5
mean_exp = reshape2::melt(mean_exp)
plot_df = merge(mean_exp, df, by = 1)
plot_df$Var1 = factor(plot_df$Var1, levels = hc$labels[hc$order])
plot_df$Var2 = factor(plot_df$Var2, levels = rev(levels(plot_df$Var2))[c(7,1:6)])

breakStr = function(s, n = 20) {
  x = gsub(paste0('(.{1,',as.character(n),'})(\\s|$)'), '\\1\n', s)
  x = substr(x, 1, nchar(x)-1)
  return(x)
}
plot_df$term_name = breakStr(plot_df$term_name, 27)
plot_df$term_name = factor(plot_df$term_name, levels = breakStr(terms[c(2,1,5,4,3,6)], 27))


plt = ggplot()+
  facet_grid(~term_name,scales = "free", space = "free_x")+
  geom_tile(data = plot_df, mapping = aes(x = Var1, y = Var2, fill = value))+
  labs(fill = "scaled mean\nexpression")+
  guides(fill = guide_colourbar(title.position = "top"))+
  scale_fill_viridis_c(option = "A")+
  theme_classic()+
  theme(axis.text = element_text(size = 7, colour = "black"),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.title = element_blank(),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 6),
        strip.text = element_text(size = 7),
        legend.position = "right")

pdf("results/Div-seq/genes_GO_time_ep_wpi.pdf", height = 2, width = 10)
print(plt)
dev.off()
```



# Mapping Div-seq to SS UMAP
Load data

```{r}
# SS datasets
multi_neuro_glut <- readRDS(file = "/links/groups/treutlein/USERS/Ashley/projects/axolotl/nucseq_axolotl/multiRNA_and_pallium/multiRNA_and_pallium/multi_neuronal_glut_subset.RDS")
multi_neuro_gaba <- readRDS(file = "/links/groups/treutlein/USERS/Ashley/projects/axolotl/nucseq_axolotl/multiRNA_and_pallium/multiRNA_and_pallium/multi_neuronal_gaba_subset.RDS")
multi_neuro_npc <- readRDS(file = "/links/groups/treutlein/USERS/Ashley/projects/axolotl/nucseq_axolotl/multiRNA_and_pallium/multi_neuronal_npc_subset.RDS")

# region data
meta_regs = read.csv("data/processed/multiome/WP_region_predictions.csv", 
                     header = T, row.names = 1)
newcellnames = rownames(meta_regs)
newcellnames = gsub("-a1-1", "-1_1", newcellnames)
newcellnames = gsub("-a1-2", "-1_2", newcellnames)
newcellnames = gsub("-a3-1", "-1_3", newcellnames)
newcellnames = gsub("-a3-2", "-1_4", newcellnames)
rownames(meta_regs) = newcellnames
multi_neuro_glut = AddMetaData(multi_neuro_glut, meta_regs)
multi_neuro_glut$region_all = multi_neuro_glut$region
multi_neuro_glut$region_all[is.na(multi_neuro_glut$region_all)] = multi_neuro_glut$pred_regions_top[is.na(multi_neuro_glut$region_all)]
multi_neuro_gaba = AddMetaData(multi_neuro_gaba, meta_regs)
multi_neuro_gaba$region_all = multi_neuro_gaba$region
multi_neuro_gaba$region_all[is.na(multi_neuro_gaba$region_all)] = multi_neuro_gaba$pred_regions_top[is.na(multi_neuro_gaba$region_all)]
multi_neuro_npc = AddMetaData(multi_neuro_npc, meta_regs)
multi_neuro_npc$region_all = multi_neuro_npc$region
multi_neuro_npc$region_all[is.na(multi_neuro_npc$region_all)] = multi_neuro_npc$pred_regions_top[is.na(multi_neuro_npc$region_all)]

# div-seq
div_srat = readRDS("data/expression/axolotl_reclust/Edu_1_2_4_6_8_12_fil_highvarfeat.RDS")
meta_div_pred = read.csv("results/Div-seq/divseq_predicted_metadata.csv", 
                         header = T, row.names = 1)
div_srat = AddMetaData(div_srat, metadata = meta_div_pred)
```

Filter dataset

```{r}
# filter metadata
div_srat@meta.data = div_srat@meta.data[,c("nCount_RNA", "nFeature_RNA", "percent.mt", "sample", "seurat_clusters", "pred_ctall", "pred_regs", "batch"), drop = F]

glut_wpi_srat = div_srat[,grepl("glut_", div_srat$pred_ctall)]
gaba_wpi_srat = div_srat[,grepl("GABA_", div_srat$pred_ctall)]
npc_wpi_srat = div_srat[,grepl("npc_", div_srat$pred_ctall)]
```


## Glutamatergic
Re-run UMAP to have model

```{r}
multi_neuro_glut = RunUMAP(multi_neuro_glut, dims = 1:30, reduction = "harmony", 
                           reduction.name = 'umap_harmony', return.model = T)
```

Joint processing of Div-seq glut

```{r}
glut_wpi_srat = NormalizeData(glut_wpi_srat)
glut_wpi_srat = FindVariableFeatures(glut_wpi_srat, nfeatures = 10000)
glut_wpi_srat = ScaleData(glut_wpi_srat, 
                          vars.to.regress = c("nCount_RNA", "percent.mt", "batch"))
glut_wpi_srat = RunPCA(glut_wpi_srat, verbose = F)

glut_wpi_srat@reductions$harmony = NULL
glut_wpi_srat@reductions$umap_harmony = NULL
# Run Harmony
glut_wpi_srat = harmony::RunHarmony(glut_wpi_srat, group.by.vars = "batch", tau = 30, sigma = 0.1,
                                    plot_convergence = F, assay.use = "RNA", verbose = F)
```

### Mapping with Seurat
Apply Seurat mapping pipeline

```{r}
glut_anchors = FindTransferAnchors(reference = multi_neuro_glut, query = glut_wpi_srat,
                                   dims = 1:30, reference.reduction = "harmony")

glut_query = TransferData(anchorset = glut_anchors, reference = multi_neuro_glut, dims = 1:30,
                          weight.reduction = glut_wpi_srat@reductions$harmony,
                          query = glut_wpi_srat, 
                          refdata = list(glut_cluster = "glut_cluster"))
glut_query = IntegrateEmbeddings(anchorset = glut_anchors, reference = multi_neuro_glut,
                                 weight.reduction = glut_wpi_srat@reductions$harmony,
                                 query = glut_query, new.reduction.name = "ref.pca")
glut_query = ProjectUMAP(query = glut_query, query.reduction = "ref.pca", 
                         reference = multi_neuro_glut, reference.dims = 1:30,
                         reference.reduction = "harmony", reduction.model = "umap_harmony")
```

Plot UMAPs (bad)

```{r}
xxx = prop.table(table(glut_query$pred_ctall, glut_query$predicted.glut_cluster),
                 margin = 1)
pheatmap::pheatmap(xxx, clustering_method = "ward.D", 
                   treeheight_row = 20, treeheight_col = 20)

csfunc = colorRampPalette(c("#df16df", "#ffd9f9"))
cols_tp = c("gray80", csfunc(6))
names(cols_tp) = c("SS", paste0(c(1,2,4,6,8,12), "_wpi"))
cols_tp = cols_tp[c(2:7,1)]


ref_df = data.frame(Embeddings(multi_neuro_glut, reduction = "umap_harmony"))
ref_df$ct = multi_neuro_glut@meta.data[rownames(ref_df),"glut_cluster"]
ref_df$cond = "SS"
ref_df$region = multi_neuro_glut$region_all

q_df = data.frame(Embeddings(glut_query, reduction = "ref.umap"))
colnames(q_df) = c("UMAP_1", "UMAP_2")
q_df$ct = glut_query@meta.data[rownames(q_df),"pred_ctall"]
q_df$cond = glut_query$sample
q_df$cond[q_df$cond=="1_wpi_pos"] = "1_wpi"
q_df$region = glut_query$pred_regs
q_df = q_df[sample(1:nrow(q_df), nrow(q_df), replace = F),]

plot_df = rbind(ref_df, q_df)
plot_df$cond = factor(plot_df$cond, levels = names(cols_tp))

ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = cond))+
  geom_point(size = 0.8)+
  scale_colour_manual(values = cols_tp)+
  theme_void()+
  theme(aspect.ratio = 1)

ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = ct))+
  geom_point(size = 0.8)+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1)

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = region),
             size = 0.7, shape = 19)+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, fill = region),
             size = 1, shape = 21, colour = "grey55", alpha = 0.7)+
  scale_colour_manual(values = reg_cols_simp)+
  scale_fill_manual(values = reg_cols_simp)+
  theme_void()+
  theme(aspect.ratio = 1)
```

### Mapping with correlation
Match each cell to the UMAP coordinates of the msot similar cell

```{r}
# colours
csfunc = colorRampPalette(c("#df16df", "#ffd9f9"))
cols_tp = c("gray90", csfunc(6))
names(cols_tp) = c("SS", paste0(c(1,2,4,6,8,12), "_wpi"))
cols_tp = cols_tp[c(2:7,1)]

# get correlations
feat = intersect(multi_neuro_glut@assays$RNA@var.features,
                 glut_query@assays$RNA@var.features)
cor_cells = cor(as.matrix(multi_neuro_glut@assays$RNA@data[feat,]), 
                as.matrix(glut_query@assays$RNA@data[feat,]), method = "sp")
saveRDS(cor_cells, file = "results/Div-seq/cor_cells_mapping_glut.RDS")

# assign max cell
max_vals = apply(cor_cells, 2, max)
max_id = apply(cor_cells, 2, which.max)
match_cells = colnames(multi_neuro_glut)[max_id]

# prepare data
ref_df = data.frame(Embeddings(multi_neuro_glut, reduction = "umap_harmony"))
ref_df$ct = multi_neuro_glut@meta.data[rownames(ref_df),"glut_cluster"]
ref_df$cond = "SS"
ref_df$region = multi_neuro_glut$region_all

q_df = data.frame(ref_df[match_cells,1:2],
                  row.names = colnames(glut_query))
q_df$ct = glut_query@meta.data[rownames(q_df),"pred_ctall"]
q_df$cond = glut_query$sample
q_df$cond[q_df$cond=="1_wpi_pos"] = "1_wpi"
q_df$region = glut_query$pred_regs
q_df = q_df[sample(1:nrow(q_df), nrow(q_df), replace = F),]

plot_df = rbind(ref_df, q_df)
plot_df$cond = factor(plot_df$cond, levels = names(cols_tp))

# plotting
plt_cond = ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = cond))+
  geom_point(size = 0.4)+
  scale_colour_manual(values = cols_tp)+
  theme_void()+
  theme(aspect.ratio = 1)

ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = ct))+
  geom_point(size = 0.8)+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1)


lab_df = data.frame("UMAP_1" = tapply(q_df$UMAP_1, q_df$ct, median),
                    "UMAP_2" = tapply(q_df$UMAP_2, q_df$ct, median))
lab_df$ct = rownames(lab_df)
tabct = table(q_df$ct)
topct = names(sort(tabct, decreasing = T))[1:5]

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2),
             size = 0.6, shape = 19, colour = "grey85")+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = ct),
             size = 0.7, shape = 20, alpha = 0.7)+
  geom_label(data = lab_df[topct,], 
             mapping = aes(x = UMAP_1, y = UMAP_2, label = ct),
             size = 2, label.padding = unit(0.05,"cm"))+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1,
        legend.position = "none")

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = region),
             size = 0.7, shape = 19)+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, fill = region),
             size = 1, shape = 21, colour = "grey55", alpha = 0.7)+
  scale_colour_manual(values = reg_cols_simp)+
  scale_fill_manual(values = reg_cols_simp)+
  theme_void()+
  theme(aspect.ratio = 1)

pdf("results/Div-seq/UMAP_mappings/glut_SS_Div_mapping_UMAP.pdf", 
    height = 3.5, width = 4)
print(plt_cond)
dev.off()
```


## GABAergic
Joint processing of Div-seq glut

```{r}
gaba_wpi_srat = NormalizeData(gaba_wpi_srat)
gaba_wpi_srat = FindVariableFeatures(gaba_wpi_srat, nfeatures = 10000)
gaba_wpi_srat = ScaleData(gaba_wpi_srat, 
                          vars.to.regress = c("nCount_RNA", "percent.mt", "batch"))
gaba_wpi_srat = RunPCA(gaba_wpi_srat, verbose = F)

gaba_wpi_srat@reductions$harmony = NULL
gaba_wpi_srat@reductions$umap_harmony = NULL
# Run Harmony
gaba_wpi_srat = harmony::RunHarmony(gaba_wpi_srat, group.by.vars = "batch", 
                                    tau = 30, sigma = 0.1,
                                    plot_convergence = F, assay.use = "RNA", verbose = F)
```

### Mapping with correlation
Match each cell to the UMAP coordinates of the most similar cell

```{r}
# colours
csfunc = colorRampPalette(c("#df16df", "#ffd9f9"))
cols_tp = c("gray90", csfunc(6))
names(cols_tp) = c("SS", paste0(c(1,2,4,6,8,12), "_wpi"))
cols_tp = cols_tp[c(2:7,1)]

# get correlations
feat = intersect(multi_neuro_gaba@assays$RNA@var.features,
                 gaba_wpi_srat@assays$RNA@var.features)
cor_gaba = cor(as.matrix(multi_neuro_gaba@assays$RNA@data[feat,]), 
               as.matrix(gaba_wpi_srat@assays$RNA@data[feat,]), method = "sp")
saveRDS(cor_gaba, file = "results/Div-seq/cor_cells_mapping_gaba.RDS")

# assign max cell
max_vals = apply(cor_gaba, 2, max)
max_id = apply(cor_gaba, 2, which.max)
match_cells = colnames(multi_neuro_gaba)[max_id]

# prepare data
ref_df = data.frame(Embeddings(multi_neuro_gaba, reduction = "umap_harmony"))
ref_df$ct = multi_neuro_gaba@meta.data[rownames(ref_df),"gaba_cluster"]
ref_df$cond = "SS"
ref_df$region = multi_neuro_gaba$region_all

q_df = data.frame(ref_df[match_cells,1:2],
                  row.names = colnames(gaba_wpi_srat))
q_df$ct = gaba_wpi_srat@meta.data[rownames(q_df),"pred_ctall"]
q_df$cond = gaba_wpi_srat$sample
q_df$cond[q_df$cond=="1_wpi_pos"] = "1_wpi"
q_df$region = gaba_wpi_srat$pred_regs
q_df = q_df[sample(1:nrow(q_df), nrow(q_df), replace = F),]

plot_df = rbind(ref_df, q_df)
plot_df$cond = factor(plot_df$cond, levels = names(cols_tp))

# plotting
plt_cond = ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = cond))+
  geom_point(size = 0.4)+
  scale_colour_manual(values = cols_tp)+
  theme_void()+
  theme(aspect.ratio = 1)

ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = ct))+
  geom_point(size = 0.8)+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1)


lab_df = data.frame("UMAP_1" = tapply(q_df$UMAP_1, q_df$ct, median),
                    "UMAP_2" = tapply(q_df$UMAP_2, q_df$ct, median))
lab_df$ct = rownames(lab_df)
tabct = table(q_df$ct)
topct = names(sort(tabct, decreasing = T))[1:5]

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2),
             size = 0.6, shape = 19, colour = "grey85")+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = ct),
             size = 0.7, shape = 20, alpha = 0.7)+
  geom_label(data = lab_df[topct,], 
             mapping = aes(x = UMAP_1, y = UMAP_2, label = ct),
             size = 2, label.padding = unit(0.05,"cm"))+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1,
        legend.position = "none")

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = region),
             size = 0.7, shape = 19)+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, fill = region),
             size = 1, shape = 21, colour = "grey55", alpha = 0.7)+
  scale_colour_manual(values = reg_cols_simp)+
  scale_fill_manual(values = reg_cols_simp)+
  theme_void()+
  theme(aspect.ratio = 1)

pdf("results/Div-seq/UMAP_mappings/gaba_SS_Div_mapping_UMAP.pdf", 
    height = 3.5, width = 4)
print(plt_cond)
dev.off()
```


## NPCs
Joint processing of Div-seq glut

```{r}
npc_wpi_srat = NormalizeData(npc_wpi_srat)
npc_wpi_srat = FindVariableFeatures(npc_wpi_srat, nfeatures = 10000)
npc_wpi_srat = ScaleData(npc_wpi_srat, 
                         vars.to.regress = c("nCount_RNA", "percent.mt", "batch"))
npc_wpi_srat = RunPCA(npc_wpi_srat, verbose = F)

npc_wpi_srat@reductions$harmony = NULL
npc_wpi_srat@reductions$umap_harmony = NULL
# Run Harmony
npc_wpi_srat = harmony::RunHarmony(npc_wpi_srat, group.by.vars = "batch", 
                                   tau = 30, sigma = 0.1,
                                   plot_convergence = F, assay.use = "RNA", verbose = F)
```

### Mapping with correlation
Match each cell to the UMAP coordinates of the most similar cell

```{r}
# colours
csfunc = colorRampPalette(c("#df16df", "#ffd9f9"))
cols_tp = c("gray90", csfunc(6))
names(cols_tp) = c("SS", paste0(c(1,2,4,6,8,12), "_wpi"))
cols_tp = cols_tp[c(2:7,1)]

# get correlations
feat = intersect(multi_neuro_npc@assays$RNA@var.features,
                 npc_wpi_srat@assays$RNA@var.features)
cor_npc = cor(as.matrix(multi_neuro_npc@assays$RNA@data[feat,]), 
              as.matrix(npc_wpi_srat@assays$RNA@data[feat,]), method = "sp")
saveRDS(cor_npc, file = "results/Div-seq/cor_cells_mapping_npc.RDS")

# assign max cell
max_vals = apply(cor_npc, 2, max)
max_id = apply(cor_npc, 2, which.max)
match_cells = colnames(multi_neuro_npc)[max_id]

# prepare data
ref_df = data.frame(Embeddings(multi_neuro_npc, reduction = "umap_harmony"))
ref_df$ct = multi_neuro_npc@meta.data[rownames(ref_df),"npc_cluster"]
ref_df$cond = "SS"
ref_df$region = multi_neuro_npc$region_all

q_df = data.frame(ref_df[match_cells,1:2],
                  row.names = colnames(npc_wpi_srat))
q_df$ct = npc_wpi_srat@meta.data[rownames(q_df),"pred_ctall"]
q_df$cond = npc_wpi_srat$sample
q_df$cond[q_df$cond=="1_wpi_pos"] = "1_wpi"
q_df$region = npc_wpi_srat$pred_regs
q_df = q_df[sample(1:nrow(q_df), nrow(q_df), replace = F),]

plot_df = rbind(ref_df, q_df)
plot_df$cond = factor(plot_df$cond, levels = names(cols_tp))

# plotting
plt_cond = ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = cond))+
  geom_point(size = 0.4)+
  scale_colour_manual(values = cols_tp)+
  theme_void()+
  theme(aspect.ratio = 1)

ggplot(plot_df, aes(x = UMAP_1, y = UMAP_2, colour = ct))+
  geom_point(size = 0.8)+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1)


lab_df = data.frame("UMAP_1" = tapply(q_df$UMAP_1, q_df$ct, median),
                    "UMAP_2" = tapply(q_df$UMAP_2, q_df$ct, median))
lab_df$ct = rownames(lab_df)
tabct = table(q_df$ct)
topct = names(sort(tabct, decreasing = T))[1:5]

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2),
             size = 0.6, shape = 19, colour = "grey85")+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = ct),
             size = 0.7, shape = 20, alpha = 0.7)+
  geom_label(data = lab_df[topct,], 
             mapping = aes(x = UMAP_1, y = UMAP_2, label = ct),
             size = 2, label.padding = unit(0.05,"cm"))+
  scale_colour_manual(values = cols_cc[unique(plot_df$ct)])+
  theme_void()+
  theme(aspect.ratio = 1,
        legend.position = "none")

ggplot()+
  geom_point(data = plot_df[plot_df$cond=="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, colour = region),
             size = 0.7, shape = 19)+
  geom_point(data = plot_df[plot_df$cond!="SS",], 
             mapping = aes(x = UMAP_1, y = UMAP_2, fill = region),
             size = 1, shape = 21, colour = "grey55", alpha = 0.7)+
  scale_colour_manual(values = reg_cols_simp)+
  scale_fill_manual(values = reg_cols_simp)+
  theme_void()+
  theme(aspect.ratio = 1)

pdf("results/Div-seq/UMAP_mappings/npc_SS_Div_mapping_UMAP.pdf", 
    height = 3.5, width = 4)
print(plt_cond)
dev.off()
```